name: ToDoApp

trigger:
- main

resources:
  repositories:
    - repository: self
      type: git
      name: getkam/todo
      connection: github.com_getkam

stages:
    - stage: Build_and_Test
      displayName: Build and Test
      jobs:
        - job: build_and_test
          displayName: Build and Test
          pool:
              vmImage: 'ubuntu-latest'
          steps:
              - task: UsePythonVersion@0
                inputs:
                    versionSpec: 3.11
                displayName: Use Python 3.11
              - script: |
                    pip install --upgrade pip
                    pip install -r requirements.txt
                displayName: 'Installing dependencies'    
              - script: |
                  echo "Running tests..."
                  pytest
                displayName: "Run pytest"
                env:
                  MONGO_URI: $(MONGO_URI)
    - stage: Docker_build_and_push
      displayName: Docker build and Push
      jobs:
        - job: docker_build_and_push
          displayName: Docker build and push
          steps:
            - task: Docker@2
              inputs:
                containerRegistry: 'mgConn'
                command: 'login'
            - task: Docker@2
              inputs:
                containerRegistry: 'mgConn'
                repository: 'todo-app'
                command: 'buildAndPush'
                Dockerfile: '**/Dockerfile'
                tags: |
                      latest
                      $(Build.BuildId)
                      $(Build.SourceVersion)
    - stage: Deploy
      displayName: Delpoy Web App
      dependsOn: Docker_build_and_push
      jobs: 
        - job: deploy_we_app
          displayName: Deploy to web app
          steps:
            - task: AzureWebAppContainer@1
              inputs:
                azureSubscription: 'armConn'
                appName: 'ToDoApp'
                containers: 'devopslearningacr/todo-app:latest'